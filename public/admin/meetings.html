<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×™×©×™×‘×•×ª ×•×¤×¨×•×˜×•×§×•×œ×™× - ××¢×¨×›×ª × ×™×”×•×œ ×™×™×©×•×‘ ××™×¦×“</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/admin/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <h2>××™×¦×“</h2>
        <span>××¢×¨×›×ª × ×™×”×•×œ ×™×™×©×•×‘</span>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <span class="nav-section-title">×¨××©×™</span>
          <a href="/admin/dashboard.html" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">×œ×•×— ×‘×§×¨×”</span>
          </a>
          <a href="/admin/requests.html" class="nav-item">
            <span class="nav-icon">ğŸ“¬</span>
            <span class="nav-text">×¤× ×™×•×ª ×ª×•×©×‘×™×</span>
          </a>
        </div>
        <div class="nav-section">
          <span class="nav-section-title">×§×”×™×œ×”</span>
          <a href="/admin/events.html" class="nav-item">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-text">×œ×•×— ××™×¨×•×¢×™×</span>
          </a>
          <a href="/admin/meetings.html" class="nav-item active">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">×™×©×™×‘×•×ª ×•×¤×¨×•×˜×•×§×•×œ×™×</span>
          </a>
          <a href="/admin/announcements.html" class="nav-item">
            <span class="nav-icon">ğŸ“¢</span>
            <span class="nav-text">×”×•×“×¢×•×ª</span>
          </a>
        </div>
        <div class="nav-section">
          <span class="nav-section-title">× ×™×”×•×œ</span>
          <a href="/admin/employees.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¥</span>
            <span class="nav-text">× ×™×”×•×œ ×¢×•×‘×“×™×</span>
          </a>
          <a href="/admin/budget.html" class="nav-item">
            <span class="nav-icon">ğŸ’°</span>
            <span class="nav-text">× ×™×”×•×œ ×ª×§×¦×™×‘</span>
          </a>
          <a href="/admin/planning.html" class="nav-item">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">×ª×›× ×•×Ÿ ×œ×˜×•×•×— ××¨×•×š</span>
          </a>
          <a href="/admin/settings.html" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">×”×’×“×¨×•×ª</span>
          </a>
        </div>
      </nav>
      <div class="sidebar-footer">
        <a href="/" class="nav-item">
          <span class="nav-icon">ğŸ </span>
          <span class="nav-text">×œ××ª×¨ ×”×¨××©×™</span>
        </a>
        <a href="#" class="nav-item" onclick="logout()">
          <span class="nav-icon">ğŸšª</span>
          <span class="nav-text">×”×ª× ×ª×§×•×ª</span>
        </a>
      </div>
    </aside>

    <button class="admin-menu-toggle" onclick="toggleSidebar()">â˜°</button>

    <main class="admin-main">
      <header class="admin-header">
        <div class="header-right">
          <h1>×™×©×™×‘×•×ª ×•×¤×¨×•×˜×•×§×•×œ×™×</h1>
        </div>
        <div class="header-left">
          <button class="btn btn-secondary" onclick="openAITranscription()">
            <span>ğŸ¤–</span> ×ª××œ×•×œ AI
          </button>
          <button class="btn btn-primary" onclick="showCreateMeetingModal()">
            <span>â•</span> ×™×©×™×‘×” ×—×“×©×”
          </button>
          <div class="header-user">
            <span id="userName">×©×œ×•×</span>
          </div>
        </div>
      </header>

      <div class="admin-content">
        <!-- Stats -->
        <section class="stats-grid small">
          <div class="stat-card mini">
            <div class="stat-icon" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">ğŸ“…</div>
            <div class="stat-info">
              <span class="stat-value" id="upcomingCount">0</span>
              <span class="stat-label">×™×©×™×‘×•×ª ×§×¨×•×‘×•×ª</span>
            </div>
          </div>
          <div class="stat-card mini">
            <div class="stat-icon" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);">ğŸ“‹</div>
            <div class="stat-info">
              <span class="stat-value" id="protocolsCount">0</span>
              <span class="stat-label">×¤×¨×•×˜×•×§×•×œ×™×</span>
            </div>
          </div>
          <div class="stat-card mini">
            <div class="stat-icon" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">â³</div>
            <div class="stat-info">
              <span class="stat-value" id="pendingProtocols">0</span>
              <span class="stat-label">×××ª×™× ×™× ×œ××™×©×•×¨</span>
            </div>
          </div>
          <div class="stat-card mini">
            <div class="stat-icon" style="background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);">ğŸ“Š</div>
            <div class="stat-info">
              <span class="stat-value" id="totalMeetings">0</span>
              <span class="stat-label">×¡×”"×› ×™×©×™×‘×•×ª</span>
            </div>
          </div>
        </section>

        <!-- AI Transcription Info -->
        <section class="dashboard-section ai-info">
          <div class="ai-banner">
            <div class="ai-icon">ğŸ¤–</div>
            <div class="ai-text">
              <h3>×ª××œ×•×œ ××•×˜×•××˜×™ ×¢× AI</h3>
              <p>×”×¢×œ×” ×”×§×œ×˜×ª ×™×©×™×‘×” ×•×§×‘×œ ×ª××œ×•×œ ××œ× ×•×¡×™×›×•× ××•×˜×•××˜×™ ×ª×•×š ×“×§×•×ª</p>
            </div>
            <button class="btn btn-primary" onclick="openAITranscription()">×”×ª×—×œ ×ª××œ×•×œ</button>
          </div>
        </section>

        <!-- Upcoming Meetings -->
        <section class="dashboard-section">
          <div class="section-header">
            <h2>ğŸ“… ×™×©×™×‘×•×ª ×§×¨×•×‘×•×ª</h2>
          </div>
          <div class="meetings-grid" id="upcomingMeetings">
            <div class="loading-text">×˜×•×¢×Ÿ ×™×©×™×‘×•×ª...</div>
          </div>
        </section>

        <!-- Meetings List -->
        <section class="dashboard-section">
          <div class="section-header">
            <h2>ğŸ“‹ ×›×œ ×”×™×©×™×‘×•×ª ×•×”×¤×¨×•×˜×•×§×•×œ×™×</h2>
            <div class="filter-tabs">
              <button class="tab active" onclick="filterMeetings('all')">×”×›×œ</button>
              <button class="tab" onclick="filterMeetings('with-protocol')">×¢× ×¤×¨×•×˜×•×§×•×œ</button>
              <button class="tab" onclick="filterMeetings('pending')">×××ª×™×Ÿ ×œ×¤×¨×•×˜×•×§×•×œ</button>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>×ª××¨×™×š</th>
                  <th>×›×•×ª×¨×ª</th>
                  <th>×¡×•×’</th>
                  <th>××©×ª×ª×¤×™×</th>
                  <th>×¤×¨×•×˜×•×§×•×œ</th>
                  <th>×¤×¢×•×œ×•×ª</th>
                </tr>
              </thead>
              <tbody id="meetingsTable">
                <tr><td colspan="6" class="loading">×˜×•×¢×Ÿ...</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Meeting Modal -->
  <div id="meetingModal" class="modal-overlay hidden">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 id="meetingModalTitle">×™×©×™×‘×” ×—×“×©×”</h3>
        <button class="modal-close" onclick="closeMeetingModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="meetingForm">
          <input type="hidden" id="meetingId">
          <div class="form-row">
            <div class="form-group">
              <label>×›×•×ª×¨×ª ×”×™×©×™×‘×” *</label>
              <input type="text" id="meetingTitle" required placeholder="×™×©×™×‘×ª ×•×¢×“ ×—×•×“×©×™×ª">
            </div>
            <div class="form-group">
              <label>×¡×•×’ ×™×©×™×‘×”</label>
              <select id="meetingType">
                <option value="regular">×™×©×™×‘×” ×¨×’×™×œ×”</option>
                <option value="emergency">×™×©×™×‘×ª ×—×™×¨×•×</option>
                <option value="annual">××¡×™×¤×” ×©× ×ª×™×ª</option>
                <option value="special">×™×©×™×‘×” ××™×•×—×“×ª</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>×ª××¨×™×š ×•×©×¢×” *</label>
              <input type="datetime-local" id="meetingDate" required>
            </div>
            <div class="form-group">
              <label>××™×§×•×</label>
              <input type="text" id="meetingLocation" placeholder="×—×“×¨ ×™×©×™×‘×•×ª / ×–×•×">
            </div>
          </div>
          <div class="form-group full">
            <label>××©×ª×ª×¤×™×</label>
            <input type="text" id="meetingParticipants" placeholder="×©××•×ª ×”××©×ª×ª×¤×™×, ××•×¤×¨×“×™× ×‘×¤×¡×™×§×™×">
          </div>
          <div class="form-group full">
            <label>×¡×“×¨ ×™×•×</label>
            <textarea id="meetingAgenda" rows="4" placeholder="1. ×¤×ª×™×—×”&#10;2. ××™×©×•×¨ ×¤×¨×•×˜×•×§×•×œ ×§×•×“×&#10;3. ..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeMeetingModal()">×‘×™×˜×•×œ</button>
        <button class="btn btn-primary" onclick="saveMeeting()">×©××™×¨×”</button>
      </div>
    </div>
  </div>

  <!-- AI Transcription Modal -->
  <div id="aiModal" class="modal-overlay hidden">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3>×ª××œ×•×œ AI ××•×˜×•××˜×™</h3>
        <button class="modal-close" onclick="closeAIModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="ai-steps">
          <!-- Step 1: Upload -->
          <div class="ai-step active" id="step1">
            <h4>×©×œ×‘ 1: ×”×¢×œ××ª ×”×§×œ×˜×”</h4>
            <div class="upload-zone" id="uploadZone">
              <input type="file" id="audioFile" accept="audio/*,video/*" onchange="handleFileUpload(event)" hidden>
              <div class="upload-content" onclick="document.getElementById('audioFile').click()">
                <span class="upload-icon">ğŸ™ï¸</span>
                <p>×œ×—×¥ ×œ×”×¢×œ××ª ×§×•×‘×¥ ××•×“×™×•/×•×™×“××•</p>
                <small>MP3, WAV, M4A, MP4 - ×¢×“ 500MB</small>
              </div>
            </div>
            <div class="file-info hidden" id="fileInfo">
              <span class="file-name"></span>
              <span class="file-size"></span>
              <button class="btn btn-sm" onclick="clearFile()">×”×¡×¨</button>
            </div>
            <div class="form-group" style="margin-top: 20px;">
              <label>×‘×—×¨ ×™×©×™×‘×” ×œ×”×¦××“×ª ×”×ª××œ×•×œ</label>
              <select id="aiMeetingSelect">
                <option value="">×¦×•×¨ ×™×©×™×‘×” ×—×“×©×”</option>
              </select>
            </div>
          </div>

          <!-- Step 2: Processing -->
          <div class="ai-step hidden" id="step2">
            <h4>×©×œ×‘ 2: ××¢×‘×“...</h4>
            <div class="processing-animation">
              <div class="spinner-large"></div>
              <p id="processingStatus">××¢×œ×” ×§×•×‘×¥...</p>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>

          <!-- Step 3: Results -->
          <div class="ai-step hidden" id="step3">
            <h4>×©×œ×‘ 3: ×ª×•×¦××•×ª</h4>
            <div class="transcription-tabs">
              <button class="tab active" onclick="showTab('summary')">×¡×™×›×•×</button>
              <button class="tab" onclick="showTab('full')">×ª××œ×•×œ ××œ×</button>
            </div>
            <div class="transcription-content" id="summaryContent">
              <div class="summary-box" id="aiSummary"></div>
            </div>
            <div class="transcription-content hidden" id="fullContent">
              <div class="full-transcript" id="aiTranscript"></div>
            </div>
            <div class="transcription-actions">
              <button class="btn btn-secondary" onclick="editTranscription()">âœï¸ ×¢×¨×™×›×”</button>
              <button class="btn btn-primary" onclick="generateProtocol()">ğŸ“„ ×¦×•×¨ ×¤×¨×•×˜×•×§×•×œ</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAIModal()">×¡×’×•×¨</button>
        <button class="btn btn-primary hidden" id="startTranscriptionBtn" onclick="startTranscription()">×”×ª×—×œ ×ª××œ×•×œ</button>
      </div>
    </div>
  </div>

  <!-- Protocol Modal -->
  <div id="protocolModal" class="modal-overlay hidden">
    <div class="modal modal-xl">
      <div class="modal-header">
        <h3>×¤×¨×•×˜×•×§×•×œ ×™×©×™×‘×”</h3>
        <button class="modal-close" onclick="closeProtocolModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="protocol-preview" id="protocolPreview">
          <!-- Protocol content will be injected here -->
        </div>
        <div class="protocol-editor hidden" id="protocolEditor">
          <textarea id="protocolContent" rows="20"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeProtocolModal()">×¡×’×•×¨</button>
        <button class="btn btn-secondary" onclick="toggleProtocolEdit()">âœï¸ ×¢×¨×™×›×”</button>
        <button class="btn btn-secondary" onclick="exportProtocolPDF()">ğŸ“¥ ×”×•×¨×“ PDF</button>
        <button class="btn btn-primary" onclick="approveProtocol()">âœ… ××©×¨ ×•×¤×¨×¡×</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <style>
    .ai-banner {
      display: flex;
      align-items: center;
      gap: 20px;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
    }
    .ai-icon { font-size: 3rem; }
    .ai-text { flex: 1; }
    .ai-text h3 { margin: 0 0 5px 0; }
    .ai-text p { margin: 0; opacity: 0.9; }
    .ai-banner .btn { background: white; color: var(--primary); }

    .meetings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    .meeting-card {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--gray-100);
    }
    .meeting-card .meeting-date {
      font-size: 0.9rem;
      color: var(--gray-500);
      margin-bottom: 8px;
    }
    .meeting-card h4 { margin: 0 0 8px 0; }
    .meeting-card .meeting-type {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      background: var(--primary-100);
      color: var(--primary);
    }
    .meeting-card .meeting-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .filter-tabs { display: flex; gap: 8px; }
    .tab {
      padding: 6px 14px;
      border: 1px solid var(--gray-200);
      border-radius: 20px;
      background: white;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .protocol-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
    }
    .protocol-badge.ready { background: #d1fae5; color: #059669; }
    .protocol-badge.pending { background: #fef3c7; color: #d97706; }
    .protocol-badge.none { background: #f3f4f6; color: #6b7280; }

    /* AI Modal Styles */
    .ai-steps { padding: 10px; }
    .ai-step { display: none; }
    .ai-step.active { display: block; }
    .ai-step h4 { margin: 0 0 20px 0; color: var(--primary); }

    .upload-zone {
      border: 2px dashed var(--gray-300);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-zone:hover {
      border-color: var(--primary);
      background: var(--primary-50);
    }
    .upload-icon { font-size: 3rem; display: block; margin-bottom: 10px; }

    .file-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--gray-50);
      border-radius: 8px;
      margin-top: 10px;
    }

    .processing-animation {
      text-align: center;
      padding: 40px;
    }
    .spinner-large {
      width: 60px;
      height: 60px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 20px;
    }
    .progress-fill {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s;
    }

    .transcription-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .transcription-content {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    .summary-box, .full-transcript {
      white-space: pre-wrap;
      line-height: 1.8;
    }
    .transcription-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      justify-content: center;
    }

    .protocol-preview {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 40px;
      max-height: 500px;
      overflow-y: auto;
    }
    .protocol-header {
      text-align: center;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 20px;
      margin-bottom: 20px;
    }
    .protocol-header h2 { margin: 0; }
    .protocol-header .meeting-info { color: var(--gray-600); margin-top: 10px; }

    .modal-xl { max-width: 900px; }
  </style>

  <script>
    const API_BASE = '/api';
    let authToken = localStorage.getItem('meitzad_token') || localStorage.getItem('authToken');
    let allMeetings = [];
    let currentFilter = 'all';
    let uploadedFile = null;
    let currentMeetingId = null;

    document.addEventListener('DOMContentLoaded', () => {
      if (!authToken) {
        window.location.href = '/#login';
        return;
      }
      loadMeetings();
      loadStats();
    });

    async function apiRequest(url, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`,
        ...options.headers
      };
      const response = await fetch(url, { ...options, headers });
      if (!response.ok) {
        const error = await response.json().catch(() => ({ error: '×©×’×™××”' }));
        throw new Error(error.error || '×©×’×™××ª ×©×¨×ª');
      }
      return response.json();
    }

    async function loadStats() {
      try {
        const stats = await apiRequest(`${API_BASE}/meetings/stats`);
        document.getElementById('upcomingCount').textContent = stats.upcoming || 0;
        document.getElementById('protocolsCount').textContent = stats.withProtocol || 0;
        document.getElementById('pendingProtocols').textContent = stats.pendingProtocol || 0;
        document.getElementById('totalMeetings').textContent = stats.total || 0;
      } catch (error) {
        console.error('Stats error:', error);
      }
    }

    async function loadMeetings() {
      try {
        allMeetings = await apiRequest(`${API_BASE}/meetings`);
        renderUpcomingMeetings();
        renderMeetingsTable();
        populateMeetingSelect();
      } catch (error) {
        console.error('Load meetings error:', error);
        document.getElementById('meetingsTable').innerHTML =
          '<tr><td colspan="6" class="error">×©×’×™××” ×‘×˜×¢×™× ×ª ×™×©×™×‘×•×ª</td></tr>';
      }
    }

    function renderUpcomingMeetings() {
      const container = document.getElementById('upcomingMeetings');
      const upcoming = allMeetings.filter(m => new Date(m.date) >= new Date()).slice(0, 4);

      if (upcoming.length === 0) {
        container.innerHTML = '<div class="empty-text">××™×Ÿ ×™×©×™×‘×•×ª ×§×¨×•×‘×•×ª</div>';
        return;
      }

      const typeLabels = { regular: '×™×©×™×‘×” ×¨×’×™×œ×”', emergency: '×™×©×™×‘×ª ×—×™×¨×•×', annual: '××¡×™×¤×” ×©× ×ª×™×ª', special: '××™×•×—×“×ª' };

      container.innerHTML = upcoming.map(m => `
        <div class="meeting-card">
          <div class="meeting-date">${formatDate(m.date)}</div>
          <h4>${m.title}</h4>
          <span class="meeting-type">${typeLabels[m.type] || m.type}</span>
          <div class="meeting-actions">
            <button class="btn btn-sm btn-secondary" onclick="viewMeeting(${m.id})">×¤×¨×˜×™×</button>
            ${m.has_protocol ? `<button class="btn btn-sm btn-primary" onclick="viewProtocol(${m.id})">×¤×¨×•×˜×•×§×•×œ</button>` : ''}
          </div>
        </div>
      `).join('');
    }

    function renderMeetingsTable() {
      const tbody = document.getElementById('meetingsTable');
      let filtered = allMeetings;

      if (currentFilter === 'with-protocol') {
        filtered = allMeetings.filter(m => m.has_protocol);
      } else if (currentFilter === 'pending') {
        filtered = allMeetings.filter(m => !m.has_protocol);
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty">××™×Ÿ ×™×©×™×‘×•×ª ×œ×”×¦×’×”</td></tr>';
        return;
      }

      const typeLabels = { regular: '×¨×’×™×œ×”', emergency: '×—×™×¨×•×', annual: '×©× ×ª×™×ª', special: '××™×•×—×“×ª' };

      tbody.innerHTML = filtered.map(m => `
        <tr>
          <td>${formatDate(m.date)}</td>
          <td><strong>${m.title}</strong></td>
          <td><span class="meeting-type">${typeLabels[m.type] || m.type}</span></td>
          <td>${m.participants ? m.participants.split(',').length : '-'} ××©×ª×ª×¤×™×</td>
          <td>
            ${m.has_protocol
              ? (m.protocol_status === 'approved'
                ? '<span class="protocol-badge ready">×××•×©×¨</span>'
                : '<span class="protocol-badge pending">×˜×™×•×˜×”</span>')
              : '<span class="protocol-badge none">××™×Ÿ</span>'}
          </td>
          <td>
            <button class="btn btn-sm" onclick="viewMeeting(${m.id})">ğŸ‘ï¸</button>
            <button class="btn btn-sm" onclick="editMeeting(${m.id})">âœï¸</button>
            ${m.has_protocol
              ? `<button class="btn btn-sm" onclick="viewProtocol(${m.id})">ğŸ“„</button>`
              : `<button class="btn btn-sm" onclick="createProtocol(${m.id})">â•ğŸ“„</button>`}
          </td>
        </tr>
      `).join('');
    }

    function filterMeetings(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-tabs .tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      renderMeetingsTable();
    }

    function showCreateMeetingModal() {
      document.getElementById('meetingModalTitle').textContent = '×™×©×™×‘×” ×—×“×©×”';
      document.getElementById('meetingId').value = '';
      document.getElementById('meetingForm').reset();
      document.getElementById('meetingModal').classList.remove('hidden');
    }

    function closeMeetingModal() {
      document.getElementById('meetingModal').classList.add('hidden');
    }

    async function saveMeeting() {
      const id = document.getElementById('meetingId').value;
      const data = {
        title: document.getElementById('meetingTitle').value,
        type: document.getElementById('meetingType').value,
        date: document.getElementById('meetingDate').value,
        location: document.getElementById('meetingLocation').value,
        participants: document.getElementById('meetingParticipants').value,
        agenda: document.getElementById('meetingAgenda').value
      };

      try {
        if (id) {
          await apiRequest(`${API_BASE}/meetings/${id}`, { method: 'PUT', body: JSON.stringify(data) });
          showToast('×”×™×©×™×‘×” ×¢×•×“×›× ×”', 'success');
        } else {
          await apiRequest(`${API_BASE}/meetings`, { method: 'POST', body: JSON.stringify(data) });
          showToast('×”×™×©×™×‘×” × ×•×¦×¨×”', 'success');
        }
        closeMeetingModal();
        loadMeetings();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    function editMeeting(id) {
      const meeting = allMeetings.find(m => m.id === id);
      if (!meeting) return;

      document.getElementById('meetingModalTitle').textContent = '×¢×¨×™×›×ª ×™×©×™×‘×”';
      document.getElementById('meetingId').value = id;
      document.getElementById('meetingTitle').value = meeting.title;
      document.getElementById('meetingType').value = meeting.type;
      document.getElementById('meetingDate').value = meeting.date?.slice(0, 16);
      document.getElementById('meetingLocation').value = meeting.location || '';
      document.getElementById('meetingParticipants').value = meeting.participants || '';
      document.getElementById('meetingAgenda').value = meeting.agenda || '';
      document.getElementById('meetingModal').classList.remove('hidden');
    }

    // AI Transcription
    function openAITranscription() {
      document.getElementById('aiModal').classList.remove('hidden');
      document.getElementById('step1').classList.add('active');
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step3').classList.add('hidden');
    }

    function closeAIModal() {
      document.getElementById('aiModal').classList.add('hidden');
      clearFile();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      uploadedFile = file;
      document.getElementById('uploadZone').classList.add('hidden');
      const fileInfo = document.getElementById('fileInfo');
      fileInfo.classList.remove('hidden');
      fileInfo.querySelector('.file-name').textContent = file.name;
      fileInfo.querySelector('.file-size').textContent = formatFileSize(file.size);
      document.getElementById('startTranscriptionBtn').classList.remove('hidden');
    }

    function clearFile() {
      uploadedFile = null;
      document.getElementById('uploadZone').classList.remove('hidden');
      document.getElementById('fileInfo').classList.add('hidden');
      document.getElementById('startTranscriptionBtn').classList.add('hidden');
      document.getElementById('audioFile').value = '';
    }

    async function startTranscription() {
      if (!uploadedFile) {
        showToast('× × ×œ×”×¢×œ×•×ª ×§×•×‘×¥', 'error');
        return;
      }

      // Switch to processing step
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.add('active');
      document.getElementById('startTranscriptionBtn').classList.add('hidden');

      // Simulate AI processing (In real implementation, this would call an AI service)
      simulateTranscription();
    }

    async function simulateTranscription() {
      const statuses = [
        '××¢×œ×” ×§×•×‘×¥...',
        '××ª××œ×œ ××•×“×™×•...',
        '×× ×ª×— ×ª×•×›×Ÿ...',
        '××¡×›× ×™×©×™×‘×”...',
        '××¡×™×™×...'
      ];

      for (let i = 0; i <= 100; i += 5) {
        await new Promise(r => setTimeout(r, 200));
        document.getElementById('progressFill').style.width = i + '%';
        document.getElementById('processingStatus').textContent = statuses[Math.floor(i / 25)] || statuses[statuses.length - 1];
      }

      // Show results (demo data)
      showTranscriptionResults({
        summary: `×¡×™×›×•× ×™×©×™×‘×”

× ×•×©××™× ×©× ×“×•× ×•:
1. ××™×©×•×¨ ×¤×¨×•×˜×•×§×•×œ ×§×•×“× - ××•×©×¨ ×¤×” ××—×“
2. ×¢×“×›×•×Ÿ ×ª×§×¦×™×‘×™ - ×”×•×¦×’ ××¦×‘ ×”×ª×§×¦×™×‘ ×”× ×•×›×—×™
3. ×¤×¨×•×™×§×˜ ×©×™×¤×•×¥ ×’×™× ×” - ××•×©×¨ ×œ×”×ª×—×™×œ ×‘×¢×‘×•×“×•×ª
4. ×ª×œ×•× ×•×ª ×ª×•×©×‘×™× - × ×“×•× ×• 3 ×ª×œ×•× ×•×ª ×¢×™×§×¨×™×•×ª

×”×—×œ×˜×•×ª:
- ×œ×”×ª×—×™×œ ×‘×¤×¨×•×™×§×˜ ×”×©×™×¤×•×¥ ×ª×•×š ×—×•×“×©
- ×œ×”×§×¦×•×ª 50,000 ×©"×— ×œ×©×™×¤×•×¥
- ×œ×–××Ÿ ××¡×™×¤×ª ×ª×•×©×‘×™× ×‘× ×•×©× ×”×‘×™×˜×—×•×Ÿ

××©×™××•×ª ×œ×”××©×š:
- ×™×•"×¨: ×œ×¤× ×•×ª ×œ×§×‘×œ×Ÿ ×œ×§×‘×œ×ª ×”×¦×¢×ª ××—×™×¨
- ×’×–×‘×¨: ×œ×”×›×™×Ÿ ×“×•"×— ×ª×§×¦×™×‘×™ ××¤×•×¨×˜
- ××–×›×™×¨: ×œ×©×œ×•×— ×”×•×“×¢×” ×œ×ª×•×©×‘×™×`,

        transcript: `[00:00] ×¤×ª×™×—×” - ×™×•"×¨ ××‘×¨×š ××ª ×”× ×•×›×—×™×
[00:45] "×©×œ×•× ×œ×›×•×œ×, ×¤×•×ª×— ××ª ×™×©×™×‘×ª ×”×•×•×¢×“ ×”×—×•×“×©×™×ª..."
[02:30] ××™×©×•×¨ ×¤×¨×•×˜×•×§×•×œ ×§×•×“×
[05:00] "×”×× ×™×© ×”×¢×¨×•×ª ×œ×¤×¨×•×˜×•×§×•×œ? ××™×Ÿ, ×××•×©×¨."
[06:00] ×¢×“×›×•×Ÿ ×ª×§×¦×™×‘×™ - ×’×–×‘×¨ ××¦×™×’
[15:00] "×¡×”"×› ×‘×§×•×¤×” 250,000 ×©"×—..."
[20:00] ×¤×¨×•×™×§×˜ ×©×™×¤×•×¥ ×’×™× ×”
[35:00] "××¦×™×¢ ×œ×”×§×¦×•×ª 50,000 ×©"×—..."
[40:00] ×ª×œ×•× ×•×ª ×ª×•×©×‘×™×
[55:00] ×¡×™×•× ×•×§×‘×™×¢×ª ×™×©×™×‘×” ×”×‘××”
[57:00] "×”×™×©×™×‘×” ×”×‘××” ×ª×ª×§×™×™× ×‘-15 ×œ×—×•×“×© ×”×‘×"`
      });
    }

    function showTranscriptionResults(data) {
      document.getElementById('step2').classList.remove('active');
      document.getElementById('step3').classList.add('active');

      document.getElementById('aiSummary').textContent = data.summary;
      document.getElementById('aiTranscript').textContent = data.transcript;
    }

    function showTab(tab) {
      document.querySelectorAll('.transcription-tabs .tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      if (tab === 'summary') {
        document.getElementById('summaryContent').classList.remove('hidden');
        document.getElementById('fullContent').classList.add('hidden');
      } else {
        document.getElementById('summaryContent').classList.add('hidden');
        document.getElementById('fullContent').classList.remove('hidden');
      }
    }

    function generateProtocol() {
      const summary = document.getElementById('aiSummary').textContent;
      const meetingSelect = document.getElementById('aiMeetingSelect');
      const meetingId = meetingSelect.value;

      closeAIModal();

      // Open protocol modal with the summary
      showProtocolPreview({
        title: '×™×©×™×‘×ª ×•×¢×“',
        date: new Date().toLocaleDateString('he-IL'),
        content: summary
      });
    }

    function showProtocolPreview(data) {
      document.getElementById('protocolPreview').innerHTML = `
        <div class="protocol-header">
          <img src="/assets/images/logo.png" alt="×œ×•×’×•" style="max-height: 60px; margin-bottom: 10px;" onerror="this.style.display='none'">
          <h2>×¤×¨×•×˜×•×§×•×œ - ${data.title}</h2>
          <div class="meeting-info">×ª××¨×™×š: ${data.date}</div>
        </div>
        <div class="protocol-body">
          <pre style="white-space: pre-wrap; font-family: inherit;">${data.content}</pre>
        </div>
      `;
      document.getElementById('protocolContent').value = data.content;
      document.getElementById('protocolModal').classList.remove('hidden');
    }

    function closeProtocolModal() {
      document.getElementById('protocolModal').classList.add('hidden');
    }

    function toggleProtocolEdit() {
      document.getElementById('protocolPreview').classList.toggle('hidden');
      document.getElementById('protocolEditor').classList.toggle('hidden');
    }

    function populateMeetingSelect() {
      const select = document.getElementById('aiMeetingSelect');
      select.innerHTML = '<option value="">×¦×•×¨ ×™×©×™×‘×” ×—×“×©×”</option>' +
        allMeetings.slice(0, 10).map(m =>
          `<option value="${m.id}">${m.title} - ${formatDate(m.date)}</option>`
        ).join('');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('he-IL', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 4000);
    }

    function toggleSidebar() {
      document.querySelector('.admin-sidebar').classList.toggle('open');
    }

    function logout() {
      localStorage.removeItem('meitzad_token');
      localStorage.removeItem('authToken');
      window.location.href = '/#login';
    }
  </script>
</body>
</html>
