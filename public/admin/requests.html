<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>× ×™×”×•×œ ×¤× ×™×•×ª - ××¢×¨×›×ª × ×™×”×•×œ ×™×™×©×•×‘ ××™×¦×“</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/admin/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <h2>××™×¦×“</h2>
        <span>××¢×¨×›×ª × ×™×”×•×œ ×™×™×©×•×‘</span>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <span class="nav-section-title">×¨××©×™</span>
          <a href="/admin/dashboard.html" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">×œ×•×— ×‘×§×¨×”</span>
          </a>
          <a href="/admin/requests.html" class="nav-item active">
            <span class="nav-icon">ğŸ“¬</span>
            <span class="nav-text">×¤× ×™×•×ª ×ª×•×©×‘×™×</span>
            <span class="nav-badge" id="newRequestsBadge">0</span>
          </a>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">×§×”×™×œ×”</span>
          <a href="/admin/events.html" class="nav-item">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-text">×œ×•×— ××™×¨×•×¢×™×</span>
          </a>
          <a href="/admin/announcements.html" class="nav-item">
            <span class="nav-icon">ğŸ“¢</span>
            <span class="nav-text">×”×•×“×¢×•×ª ×•×”×›×¨×–×•×ª</span>
            <span class="nav-badge urgent" id="urgentAnnouncementsBadge" style="display:none">!</span>
          </a>
          <a href="/admin/directory.html" class="nav-item">
            <span class="nav-icon">ğŸ“–</span>
            <span class="nav-text">×¡×¤×¨ ×˜×œ×¤×•× ×™×</span>
          </a>
          <a href="/admin/polls.html" class="nav-item">
            <span class="nav-icon">ğŸ—³ï¸</span>
            <span class="nav-text">×¡×§×¨×™× ×•×”×¦×‘×¢×•×ª</span>
          </a>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">××©××‘×™×</span>
          <a href="/admin/facilities.html" class="nav-item">
            <span class="nav-icon">ğŸ›ï¸</span>
            <span class="nav-text">×”×–×× ×ª ××ª×§× ×™×</span>
            <span class="nav-badge" id="pendingBookingsBadge" style="display:none">0</span>
          </a>
          <a href="/admin/documents.html" class="nav-item">
            <span class="nav-icon">ğŸ“„</span>
            <span class="nav-text">××¡××›×™× ×•× ×”×œ×™×</span>
          </a>
          <a href="/admin/maintenance.html" class="nav-item">
            <span class="nav-icon">ğŸ”§</span>
            <span class="nav-text">×ª×—×–×•×§×”</span>
          </a>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">× ×™×”×•×œ</span>
          <a href="/admin/meetings.html" class="nav-item">
            <span class="nav-icon">ğŸ—“ï¸</span>
            <span class="nav-text">×™×©×™×‘×•×ª ×•×¤×¨×•×˜×•×§×•×œ×™×</span>
          </a>
          <a href="/admin/budget.html" class="nav-item">
            <span class="nav-icon">ğŸ’°</span>
            <span class="nav-text">×ª×§×¦×™×‘ ×•×›×¡×¤×™×</span>
          </a>
          <a href="/admin/planning.html" class="nav-item">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">×ª×›× ×•×Ÿ ×•×¤×¨×•×™×§×˜×™×</span>
          </a>
          <a href="/admin/employees.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¥</span>
            <span class="nav-text">×¢×•×‘×“×™×</span>
          </a>
          <a href="/admin/infrastructure.html" class="nav-item">
            <span class="nav-icon">ğŸ—ï¸</span>
            <span class="nav-text">×ª×©×ª×™×•×ª</span>
          </a>
          <a href="/admin/settings.html" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">×”×’×“×¨×•×ª</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <a href="/citizen/submit.html" class="nav-item" target="_blank">
          <span class="nav-icon">ğŸ“</span>
          <span class="nav-text">×¤×•×¨×˜×œ ×ª×•×©×‘×™×</span>
        </a>
        <a href="/" class="nav-item">
          <span class="nav-icon">ğŸ </span>
          <span class="nav-text">×œ××ª×¨ ×”×¨××©×™</span>
        </a>
        <a href="#" class="nav-item" onclick="logout()">
          <span class="nav-icon">ğŸšª</span>
          <span class="nav-text">×”×ª× ×ª×§×•×ª</span>
        </a>
      </div>
    </aside>

    <!-- Mobile Menu Toggle -->
    <button class="admin-menu-toggle" onclick="toggleSidebar()">â˜°</button>

    <!-- Main Content -->
    <main class="admin-main">
      <header class="admin-header">
        <div class="header-right">
          <h1>× ×™×”×•×œ ×¤× ×™×•×ª ×ª×•×©×‘×™×</h1>
        </div>
        <div class="header-left">
          <button class="btn btn-primary" onclick="showCreateRequestModal()">
            <span>â•</span> ×¤× ×™×™×” ×—×“×©×”
          </button>
          <div class="header-user">
            <span id="userName">×©×œ×•×</span>
          </div>
        </div>
      </header>

      <div class="admin-content">
        <!-- Stats -->
        <section class="stats-grid small">
          <div class="stat-card mini">
            <div class="stat-icon new">ğŸ“¥</div>
            <div class="stat-info">
              <span class="stat-value" id="statNew">0</span>
              <span class="stat-label">×—×“×©×•×ª</span>
            </div>
          </div>
          <div class="stat-card mini">
            <div class="stat-icon progress">â³</div>
            <div class="stat-info">
              <span class="stat-value" id="statInProgress">0</span>
              <span class="stat-label">×‘×˜×™×¤×•×œ</span>
            </div>
          </div>
          <div class="stat-card mini">
            <div class="stat-icon resolved">âœ…</div>
            <div class="stat-info">
              <span class="stat-value" id="statResolved">0</span>
              <span class="stat-label">× ×¤×ª×¨×•</span>
            </div>
          </div>
          <div class="stat-card mini">
            <div class="stat-icon time">â±ï¸</div>
            <div class="stat-info">
              <span class="stat-value" id="statAvgTime">-</span>
              <span class="stat-label">×–××Ÿ ×××•×¦×¢</span>
            </div>
          </div>
        </section>

        <!-- Filters -->
        <div class="filters-bar">
          <div class="filter-group">
            <label>×¡×˜×˜×•×¡:</label>
            <select id="filterStatus" onchange="applyFilters()">
              <option value="">×”×›×œ</option>
              <option value="new">×—×“×©</option>
              <option value="in_progress">×‘×˜×™×¤×•×œ</option>
              <option value="pending">×××ª×™×Ÿ</option>
              <option value="resolved">× ×¤×ª×¨</option>
              <option value="closed">×¡×’×•×¨</option>
            </select>
          </div>
          <div class="filter-group">
            <label>×§×˜×’×•×¨×™×”:</label>
            <select id="filterCategory" onchange="applyFilters()">
              <option value="">×”×›×œ</option>
            </select>
          </div>
          <div class="filter-group">
            <label>×“×—×™×¤×•×ª:</label>
            <select id="filterPriority" onchange="applyFilters()">
              <option value="">×”×›×œ</option>
              <option value="low">× ××•×›×”</option>
              <option value="normal">×¨×’×™×œ×”</option>
              <option value="high">×’×‘×•×”×”</option>
              <option value="urgent">×“×—×•×¤×”</option>
            </select>
          </div>
          <div class="filter-group">
            <input type="text" id="searchInput" placeholder="×—×™×¤×•×©..." onkeyup="applyFilters()">
          </div>
        </div>

        <!-- Analytics Section (Collapsible) -->
        <section class="dashboard-section analytics-section">
          <div class="section-header clickable" onclick="toggleAnalytics()">
            <h2>ğŸ“Š × ×™×ª×•×— ×–×× ×™ ×ª×’×•×‘×” ×•××™×›×•×ª ×˜×™×¤×•×œ</h2>
            <button class="btn btn-icon" id="analyticsToggle">â–¼</button>
          </div>
          <div id="analyticsContent" class="analytics-content">
            <div class="analytics-grid">
              <div class="chart-box">
                <h4>×–××Ÿ ×ª×’×•×‘×” ×××•×¦×¢ ×œ×¤×™ ×§×˜×’×•×¨×™×”</h4>
                <canvas id="categoryResponseChart"></canvas>
              </div>
              <div class="chart-box">
                <h4>×”×ª×¤×œ×’×•×ª ×–×× ×™ ×¤×ª×¨×•×Ÿ</h4>
                <canvas id="timeDistributionChart"></canvas>
              </div>
            </div>
            <div class="analytics-grid">
              <div class="chart-box full">
                <h4>××’××•×ª ×¤× ×™×•×ª - 30 ×”×™××™× ×”××—×¨×•× ×™×</h4>
                <canvas id="trendsChart"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- Requests Table -->
        <section class="dashboard-section">
          <div class="section-header">
            <h2>×¨×©×™××ª ×¤× ×™×•×ª</h2>
            <a href="/citizen/portal.html" target="_blank" class="btn btn-secondary btn-sm">ğŸ”— ×¤×•×¨×˜×œ ×ª×•×©×‘×™×</a>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>××¡×¤×¨</th>
                  <th>× ×•×©×</th>
                  <th>×§×˜×’×•×¨×™×”</th>
                  <th>××’×™×©</th>
                  <th>×“×—×™×¤×•×ª</th>
                  <th>×¡×˜×˜×•×¡</th>
                  <th>×ª××¨×™×š</th>
                  <th>×¤×¢×•×œ×•×ª</th>
                </tr>
              </thead>
              <tbody id="requestsTable">
                <tr>
                  <td colspan="8" class="loading">×˜×•×¢×Ÿ...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination" id="pagination">
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Request Modal -->
  <div id="requestModal" class="modal-overlay hidden">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 id="modalTitle">×¤×¨×˜×™ ×¤× ×™×™×”</h3>
        <button class="modal-close" onclick="closeRequestModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content loaded dynamically -->
      </div>
      <div class="modal-footer" id="modalFooter">
        <button class="btn btn-secondary" onclick="closeRequestModal()">×¡×’×•×¨</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <style>
    .analytics-section .section-header.clickable { cursor: pointer; }
    .analytics-section .section-header.clickable:hover { background: var(--gray-50); }
    .analytics-content { padding: 20px 0; }
    .analytics-content.collapsed { display: none; }
    .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .chart-box { background: var(--gray-50); border-radius: 12px; padding: 20px; }
    .chart-box.full { grid-column: 1 / -1; }
    .chart-box h4 { margin: 0 0 15px 0; color: var(--gray-700); font-size: 1rem; }
    .chart-box canvas { max-height: 250px; }
    @media (max-width: 768px) {
      .analytics-grid { grid-template-columns: 1fr; }
    }
  </style>

  <script src="/js/requests.js"></script>
  <script>
    // Analytics Charts
    let categoryChart, distributionChart, trendsChart;

    function toggleAnalytics() {
      const content = document.getElementById('analyticsContent');
      const toggle = document.getElementById('analyticsToggle');
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggle.textContent = 'â–¼';
      } else {
        content.classList.add('collapsed');
        toggle.textContent = 'â–¶';
      }
    }

    async function loadAnalytics() {
      const token = localStorage.getItem('meitzad_token') || localStorage.getItem('authToken');
      try {
        const response = await fetch('/api/inquiries/stats/response-times', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) return;

        const data = await response.json();
        renderAnalyticsCharts(data);
      } catch (error) {
        console.error('Analytics load error:', error);
      }
    }

    function renderAnalyticsCharts(data) {
      const categoryLabels = {
        infrastructure: '×ª×©×ª×™×•×ª', security: '×‘×™×˜×—×•×Ÿ', environment: '×¡×‘×™×‘×”',
        education: '×—×™× ×•×š', welfare: '×¨×•×•×—×”', other: '××—×¨'
      };

      // Category Response Time Chart
      if (categoryChart) categoryChart.destroy();
      const catCtx = document.getElementById('categoryResponseChart').getContext('2d');
      categoryChart = new Chart(catCtx, {
        type: 'bar',
        data: {
          labels: data.byCategory.map(c => categoryLabels[c.category] || c.category),
          datasets: [{
            label: '×–××Ÿ ×××•×¦×¢ (×©×¢×•×ª)',
            data: data.byCategory.map(c => c.avg_hours || 0),
            backgroundColor: 'rgba(30, 58, 95, 0.7)',
            borderColor: '#1e3a5f',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, title: { display: true, text: '×©×¢×•×ª' } } }
        }
      });

      // Time Distribution Chart
      if (distributionChart) distributionChart.destroy();
      const distCtx = document.getElementById('timeDistributionChart').getContext('2d');
      distributionChart = new Chart(distCtx, {
        type: 'doughnut',
        data: {
          labels: data.timeDistribution.map(t => t.range),
          datasets: [{
            data: data.timeDistribution.map(t => t.count),
            backgroundColor: ['#10b981', '#34d399', '#fcd34d', '#fb923c', '#ef4444']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'right', rtl: true } }
        }
      });

      // Trends Chart
      if (trendsChart) trendsChart.destroy();
      const trendsCtx = document.getElementById('trendsChart').getContext('2d');
      trendsChart = new Chart(trendsCtx, {
        type: 'line',
        data: {
          labels: data.dailyCounts.map(d => new Date(d.date).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' })),
          datasets: [
            {
              label: '×¤× ×™×•×ª ×—×“×©×•×ª',
              data: data.dailyCounts.map(d => d.total),
              borderColor: '#1e3a5f',
              backgroundColor: 'rgba(30, 58, 95, 0.1)',
              fill: true,
              tension: 0.3
            },
            {
              label: '×¤× ×™×•×ª ×©× ×¤×ª×¨×•',
              data: data.dailyCounts.map(d => d.resolved),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              fill: true,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top', rtl: true } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Load analytics on page load
    document.addEventListener('DOMContentLoaded', loadAnalytics);
  </script>
</body>
</html>
